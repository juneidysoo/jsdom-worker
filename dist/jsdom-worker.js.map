{"version":3,"file":"jsdom-worker.js","sources":["../node_modules/mitt/dist/mitt.es.js","../node_modules/uuid-v4/index.js","../src/index.js"],"sourcesContent":["//      \n// An event handler can take an optional event argument\n// and should not return a value\n                                          \n                                                               \n\n// An array of all currently registered event handlers for a type\n                                            \n                                                            \n// A map of event types and their corresponding event handlers.\n                        \n                                 \n                                   \n  \n\n/** Mitt: Tiny (~200b) functional event emitter / pubsub.\n *  @name mitt\n *  @returns {Mitt}\n */\nfunction mitt(all                 ) {\n\tall = all || Object.create(null);\n\n\treturn {\n\t\t/**\n\t\t * Register an event handler for the given type.\n\t\t *\n\t\t * @param  {String} type\tType of event to listen for, or `\"*\"` for all events\n\t\t * @param  {Function} handler Function to call in response to given event\n\t\t * @memberOf mitt\n\t\t */\n\t\ton: function on(type        , handler              ) {\n\t\t\t(all[type] || (all[type] = [])).push(handler);\n\t\t},\n\n\t\t/**\n\t\t * Remove an event handler for the given type.\n\t\t *\n\t\t * @param  {String} type\tType of event to unregister `handler` from, or `\"*\"`\n\t\t * @param  {Function} handler Handler function to remove\n\t\t * @memberOf mitt\n\t\t */\n\t\toff: function off(type        , handler              ) {\n\t\t\tif (all[type]) {\n\t\t\t\tall[type].splice(all[type].indexOf(handler) >>> 0, 1);\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Invoke all handlers for the given type.\n\t\t * If present, `\"*\"` handlers are invoked after type-matched handlers.\n\t\t *\n\t\t * @param {String} type  The event type to invoke\n\t\t * @param {Any} [evt]  Any value (object is recommended and powerful), passed to each handler\n\t\t * @memberOf mitt\n\t\t */\n\t\temit: function emit(type        , evt     ) {\n\t\t\t(all[type] || []).slice().map(function (handler) { handler(evt); });\n\t\t\t(all['*'] || []).slice().map(function (handler) { handler(type, evt); });\n\t\t}\n\t};\n}\n\nexport default mitt;\n//# sourceMappingURL=mitt.es.js.map\n","\nexports = module.exports = function() {\n\tvar ret = '', value;\n\tfor (var i = 0; i < 32; i++) {\n\t\tvalue = exports.random() * 16 | 0;\n\t\t// Insert the hypens\n\t\tif (i > 4 && i < 21 && ! (i % 4)) {\n\t\t\tret += '-';\n\t\t}\n\t\t// Add the next random character\n\t\tret += (\n\t\t\t(i === 12) ? 4 : (\n\t\t\t\t(i === 16) ? (value & 3 | 8) : value\n\t\t\t)\n\t\t).toString(16);\n\t}\n\treturn ret;\n};\n\nvar uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/;\nexports.isUUID = function(uuid) {\n\treturn uuidRegex.test(uuid);\n};\n\nexports.random = function() {\n\treturn Math.random();\n};\n\n","import fs from 'fs';\nimport mitt from 'mitt';\nimport uuid from 'uuid-v4';\nimport fetch, { Response } from 'node-fetch';\n\nif (!global.URL) global.URL = {};\nif (!global.URL.$$objects) {\n\tglobal.URL.$$objects = new Map();\n\tglobal.URL.createObjectURL = blob => {\n\t\tlet id = uuid();\n\t\tglobal.URL.$$objects[id] = blob;\n\t\treturn `blob:http://localhost/${id}`;\n\t};\n}\n\nif (!global.fetch || !global.fetch.jsdomWorker) {\n\tlet oldFetch = global.fetch || fetch;\n\tglobal.fetch = function(url, opts) {\n\t\tif (url instanceof URL) {\n\t\t\turl = url.href;\n\t\t}\n\t\tif (url.match(/^file:/)) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tconst Res = global.Response || Response;\n\t\t\t\tresolve(new Res(\n\t\t\t\t\tfs.readFileSync(url.slice(7)),\n\t\t\t\t\t{ status: 200, statusText: 'OK' }\n\t\t\t\t));\n\t\t\t});\n\t\t}\n\t\telse if (url.match(/^blob:/)) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tlet fr = new FileReader();\n\t\t\t\tfr.onload = () => {\n\t\t\t\t\tconst Res = global.Response || Response;\n\t\t\t\t\tresolve(new Res(fr.result, { status: 200, statusText: 'OK' }));\n\t\t\t\t};\n\t\t\t\tfr.onerror = () => {\n\t\t\t\t\treject(fr.error);\n\t\t\t\t};\n\t\t\t\tlet id = url.match(/[^/]+$/)[0];\n\t\t\t\tfr.readAsText(global.URL.$$objects[id]);\n\t\t\t});\n\t\t}\n\t\treturn oldFetch.call(this, url, opts);\n\t};\n\tglobal.fetch.jsdomWorker = true;\n}\n\nif (!global.document) {\n\tglobal.document = {};\n}\n\nfunction Event(type) { this.type = type; }\nEvent.prototype.initEvent = Object;\nif (!global.document.createEvent) {\n\tglobal.document.createEvent = function(type) {\n\t\tlet Ctor = global[type] || Event;\n\t\treturn new Ctor(type);\n\t};\n}\n\n\nglobal.Worker = function Worker(url) {\n\tlet getScopeVar;\n\tlet messageQueue = [];\n\tlet inside = mitt();\n\tlet outside = mitt();\n\tlet scope = {\n\t\tonmessage: null,\n\t\tdispatchEvent: inside.emit,\n\t\taddEventListener: inside.on,\n\t\tremoveEventListener: inside.off,\n\t\tpostMessage(data) {\n\t\t\toutside.emit('message', { data });\n\t\t},\n\t\tfetch: global.fetch,\n\t\timportScripts() {}\n\t};\n\tinside.on('message', e => {\n\t\tlet f = scope.onmessage || getScopeVar('onmessage');\n\t\tif (f) f.call(scope, e);\n\t});\n\tthis.addEventListener = outside.on;\n\tthis.removeEventListener = outside.off;\n\tthis.dispatchEvent = outside.emit;\n\toutside.on('message', e => {\n\t\tif (this.onmessage) this.onmessage(e);\n\t});\n\tthis.postMessage = data => {\n\t\tif (messageQueue!=null) messageQueue.push(data);\n\t\telse inside.emit('message', { data });\n\t};\n\tthis.terminate = () => {\n\t\tthrow Error('Not Supported');\n\t};\n\tglobal.fetch(url)\n\t\t.then(r => r.text())\n\t\t.then(code => {\n\t\t\tlet vars = 'var self=this,global=self';\n\t\t\tfor (let k in scope) vars += `,${k}=self.${k}`;\n\t\t\tgetScopeVar = Function(\n\t\t\t\tvars + ';\\n' + code + '\\nreturn function(n){return n==\"onmessage\"?onmessage:null;}'\n\t\t\t).call(scope);\n\t\t\tlet q = messageQueue;\n\t\t\tmessageQueue = null;\n\t\t\tq.forEach(this.postMessage);\n\t\t})\n\t\t.catch(e => {\n\t\t\toutside.emit('error', e);\n\t\t\tconsole.error(e);\n\t\t});\n};\n"],"names":["mitt","all","Object","create","on","type","handler","push","off","splice","indexOf","emit","evt","slice","map","exports","module","value","ret","i","random","toString","uuidRegex","uuid","test","Math","global","URL","$$objects","createObjectURL","blob","id","fetch","jsdomWorker","url","opts","href","match","resolve","reject","Response","fs","readFileSync","status","statusText","fr","onload","result","onerror","error","readAsText","call","this","document","Event","prototype","initEvent","createEvent","Worker","onmessage","dispatchEvent","inside","addEventListener","removeEventListener","postMessage","data","outside","importScripts","e","scope","getScopeVar","f","messageQueue","terminate","then","r","text","code","vars","k","Function","q","forEach","catch","console"],"mappings":"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"}